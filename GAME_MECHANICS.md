# 游戏机制详细说明

## 📊 核心货币系统

### 1. 现金（Cash / Balance）
- **性质**：关卡内生命线，通关的唯一指标
- **继承机制**：✅ **关卡间继承**
  - 成功通关：最终余额 → 下一关起始本金
  - 爆仓归零：现金 = 0
  - 业绩未达标：保持当前余额（不减少，但也不继承到下一关）
- **初始金额**：$10,000
- **用途**：
  - 作为每关的起始本金
  - 在局间商店购买临时道具（用现金购买）

### 2. 钻石（Time Diamonds）
- **性质**：永久货币，全局保存
- **继承机制**：✅ **永久累加**
  - 获得的钻石会永久保存
  - 不会因为关卡失败而丢失
- **获取方式**：只有**超额完成目标**才能获得
- **计算公式**：分段累进汇率系统（富人税机制）

---

## 💎 钻石获取系统（阶梯汇率）

### 核心机制
只有超额利润（`最终余额 - 目标金额`）才能转化为钻石，使用**分段累进计算法**。

### 汇率阶梯表（优化版）

| 阶梯 | 超额利润区间 | 汇率 (现金:钻石) | 贬值倍数 | 说明 |
|------|------------|----------------|---------|------|
| **Tier 1** | $0 - $5,000 | 100:1 | 无 (100%) | 鼓励新手，保底收益 |
| **Tier 2** | $5,001 - $50,000 | 500:1 | 5倍 | 正常发挥区间 |
| **Tier 3** | $50,001 - $500,000 | 2,500:1 | 25倍 | 运气爆发区间 |
| **Tier 4** | $500,001 - $5,000,000 | 20,000:1 | 200倍 | 高杠杆区间，开始严格压缩 |
| **Tier 5** | $5,000,001 - $50,000,000 | 100,000:1 | 1,000倍 | 超高杠杆区间，极度压缩 |
| **Tier 6** | $50,000,001 - ∞ | 500,000:1 | 5,000倍 | 极端暴富区间，极端压缩 |

### 计算示例

**场景A：稳健玩家**
- 目标：$12,000
- 最终：$14,000
- 超额：$2,000
- 钻石：$2,000 ÷ 100 = **20 💎**

**场景B：暴富玩家（100x杠杆）**
- 目标：$12,000
- 最终：$1,012,000
- 超额：$1,000,000
- 钻石计算（优化后）：
  - Tier 1: $5,000 ÷ 100 = 50 💎
  - Tier 2: $45,000 ÷ 500 = 90 💎
  - Tier 3: $450,000 ÷ 2,500 = 180 💎
  - Tier 4: $500,000 ÷ 20,000 = 25 💎
  - **总计：345 💎**
- **注意**：利润翻了84倍，但钻石只多了17.25倍（被严重稀释）

**场景C：极端暴富玩家（超高杠杆）**
- 目标：$100,000
- 最终：$61,925,526
- 超额：$61,825,526
- 钻石计算（优化后）：
  - Tier 1: $5,000 ÷ 100 = 50 💎
  - Tier 2: $45,000 ÷ 500 = 90 💎
  - Tier 3: $450,000 ÷ 2,500 = 180 💎
  - Tier 4: $4,500,000 ÷ 20,000 = 225 💎
  - Tier 5: $45,000,000 ÷ 100,000 = 450 💎
  - Tier 6: $11,825,526 ÷ 500,000 = 23 💎
  - **总计：1,018 💎**
- **注意**：超额利润$61,825,526，但只获得1,018💎（优化前是6,132💎，减少了83%）

### 钻石矿机加成
- 装备"钻石矿机"可以增加钻石获取量
- 加成：每级 +10%（Lv1: +10%, Lv2: +20%, ..., Lv5: +50%）
- 最终钻石 = 基础钻石 × (1 + 加成)

---

## 🎯 动态难度系统（富人税）

### 下一关目标计算

**基础规则**：
- 如果关卡有预设 `targetMultiplier`，优先使用
- 否则使用动态难度系统

**动态增长率公式**：
```
基础增长率 = 1.2 (20%增长)

如果 业绩倍数 > 1.5:
  增长率 = 1.2 + (业绩倍数 - 1.5) × 0.5
  最高封顶 = 2.0 (100%增长)

下一关目标 = 当前现金 × 增长率
```

**业绩倍数** = `最终余额 / 目标金额`

### 难度惩罚示例

| 业绩倍数 | 增长率 | 下一关目标增长 | 说明 |
|---------|--------|--------------|------|
| 1.0-1.5 | 1.2x | +20% | 正常难度 |
| 1.6 | 1.25x | +25% | 轻微惩罚 |
| 2.0 | 1.45x | +45% | 中等惩罚 |
| 3.0 | 1.95x | +95% | 严重惩罚 |
| 4.0+ | 2.0x | +100% | 最大惩罚（封顶） |

**设计目的**：防止100x杠杆带来的数值崩坏，保证游戏挑战性

---

## 🎮 关卡系统

### 关卡结构
- **4个章节**：黄金时代(1990-2000)、次贷风云(2000-2010)、量化狂潮(2010-2020)、赛博纪元(2020-2025)
- **每个关卡拆分为4个阶段（Phase）**：
  - Phase 1: 初期
  - Phase 2: 中期
  - Phase 3: 后期
  - Phase 4: 终局（BOSS关卡的Phase 4是最终BOSS）

### 解锁机制
1. **Phase顺序解锁**：
   - 完成 Phase 1 → 解锁 Phase 2
   - 完成 Phase 2 → 解锁 Phase 3
   - 完成 Phase 3 → 解锁 Phase 4
2. **Level顺序解锁**：
   - 完成 Level N 的 Phase 4 → 解锁 Level N+1 的 Phase 1
3. **章节解锁**：
   - 完成当前章节最后一个Level的Phase 4 → 解锁下一章节第一个Level的Phase 1

### 关卡难度
- 每个阶段使用不同的数据段和随机趋势
- 关卡名称隐藏多空提示（如"1990年市场"而非"崩盘"）
- 增加判断难度，避免通过名称判断方向

---

## 🛒 商店系统

### 1. 黑市商店（用钻石购买）

#### 永久装备（Equipment）
| 装备 | 效果 | 价格（Lv1-5） |
|------|------|--------------|
| **反重力引擎** | 减缓下跌时的坠落速度 | 50, 150, 300, 600, 1200 💎 |
| | Lv1: -10% | Lv2: -20% | Lv3: -30% | Lv4: -40% | Lv5: -50% |
| **高频雷达** | 提前预警市场波动 | 100, 200, 400, 800, 1600 💎 |
| | Lv1: +0.5秒 | Lv2: +1.0秒 | Lv3: +1.5秒 | Lv4: +2.0秒 | Lv5: +2.5秒 |
| **钻石矿机** | 结算时钻石获取量增加 | 200, 400, 800, 1600, 3200 💎 |
| | Lv1: +10% | Lv2: +20% | Lv3: +30% | Lv4: +40% | Lv5: +50% |

#### 消耗品（Consumable）
| 消耗品 | 效果 | 价格 | 限制 |
|--------|------|------|------|
| **熔断保护器** | 抵挡一次必死的爆仓 | 150 💎 | 每关限带1个 |
| **时间胶囊** | K线回退3秒（悔棋） | 200 💎 | 无限制 |
| **内幕消息卡** | 显示未来5秒走势（虚线） | 300 💎 | 无限制 |

### 2. 局间商店（用现金购买，仅对下一关有效）

| 临时道具 | 效果 | 价格 |
|---------|------|------|
| **强力大力丸** | 下一关允许开启100x杠杆 | $500 |
| **止损机器人** | 下一关如果做错方向，可以无损平仓一次 | $300 |
| **幸运草** | 下一关必定是上涨行情（多头福利） | $800 |
| **时间冻结液** | 下一关增加10秒交易时间 | $400 |

**注意**：临时道具在下一关开始时生效，使用后消失

---

## 💀 失败与复活机制（精细损失系统）

### 失败类型

#### 1. 爆仓归零（Liquidation）
- **条件**：收益率 ≤ -100%
- **损失惩罚**：
  - **现金**：完全归零（`currentCash = 0`）
  - **钻石**：根据起始本金扣减（使用平方根/对数缩放，避免过大）
    - 公式：`min(250, max(50, sqrt(本金/100) 或 log10(本金/1000) × 50))`
    - 范围：50-250💎
    - 示例：起始$100,000 → 约扣减100💎
  - 死亡次数 +1
  - 无法继续游戏

#### 2. 业绩未达标（Failed）
- **条件**：最终余额 < 目标金额（但 > 0）
- **损失惩罚**（根据损失比例）：
  
  | 损失比例 | 现金惩罚 | 钻石惩罚 | 说明 |
  |---------|---------|---------|------|
  | < 10% | 最终余额 × 损失比例 × 0.8 | 每$20,000损失扣1💎（封顶30💎） | 轻微损失 |
  | 10-30% | 最终余额 × 损失比例 × 0.8 | 每$10,000损失扣1💎（封顶80💎） | 中等损失 |
  | 30-50% | 最终余额 × 损失比例 × 0.8 | 每$5,000损失扣1💎（封顶150💎） | 严重损失 |
  | > 50% | 最终余额 × 50%（封顶） | 每$2,000损失扣1💎（封顶300💎） | 极度损失 |
  
  **注意**：钻石惩罚基于"实际损失金额"而非"起始本金"，避免本金过大时惩罚过高
  
  - **最小保护**：至少保留10%起始本金（除非爆仓）
  - **无法解锁下一关**

### 复活机制（动态成本）

#### 爆仓复活
- **基础成本**：100 💎
- **动态成本**：每$1000起始本金增加1💎（最高400💎）
- **总成本**：100-500 💎（根据起始本金）
- **效果**：恢复50%初始本金（$5,000）
- **结果**：重新挑战本关
- **注意**：需要先承受钻石惩罚，再支付复活成本

#### 业绩未达标补救
- **基础成本**：50 💎
- **动态成本**：每$5000差额增加1💎（最高150💎）
- **总成本**：50-200 💎（根据差额）
- **效果**：现金补齐到目标金额（**避免惩罚**）
- **结果**：视为通关，解锁下一关
- **注意**：如果选择补救，可以避免现金和钻石惩罚

---

## 📈 交易系统

### 杠杆选项
- 可用杠杆：1x, 5x, 10x, 25x, 50x, 100x
- 100x杠杆需要购买"强力大力丸"临时道具

### 收益率计算
```
实际收益率 = 价格变化% × 杠杆倍数 × 方向系数
方向系数：做多 = +1，做空 = -1

最终余额 = 起始本金 × (1 + 实际收益率 / 100)
```

### 爆仓条件
- 当收益率 ≤ -100% 时爆仓
- 熔断保护器可以抵挡一次必死爆仓

---

## 🎯 结算流程

### 成功通关流程
1. **计算最终余额**：`起始本金 × (1 + 收益率 / 100)`
2. **判断是否达标**：`最终余额 >= 目标金额`
3. **计算超额利润**：`最终余额 - 目标金额`
4. **计算钻石奖励**：使用阶梯汇率系统
5. **计算下一关目标**：使用动态难度系统
6. **更新状态**：
   - `currentCash = 最终余额`（现金继承）
   - `timeDiamonds += 钻石奖励`（钻石累加）
   - 解锁下一个phase或level
7. **进入局间商店**：可以用现金购买临时道具

### 失败处理流程
- **爆仓**：
  1. 应用损失惩罚（现金归零 + 钻石扣减）
  2. 可选择复活（100-500💎，动态成本）
  3. 复活后恢复50%初始本金，重新挑战
  
- **未达标**：
  1. 应用损失惩罚（现金扣减 + 钻石扣减，根据损失比例）
  2. 可选择补救（50-200💎，动态成本，**避免惩罚**）
  3. 补救后视为通关，解锁下一关

---

## 🔄 数据继承机制总结（精细版）

| 状态 | 成功通关 | 业绩未达标 | 爆仓归零 |
|------|---------|-----------|---------|
| **现金** | ✅ 继承（最终余额） | ⚠️ 扣减后继承（最终余额 - 惩罚） | ❌ 归零 |
| **钻石** | ✅ 累加（+奖励） | ⚠️ 扣减（-惩罚，根据损失比例） | ⚠️ 扣减（-惩罚，最高200💎） |
| **解锁** | ✅ 解锁下一关 | ❌ 不解锁 | ❌ 不解锁 |

### 损失惩罚示例

**场景A：轻微未达标**
- 起始：$10,000
- 目标：$12,000
- 最终：$11,500（损失5%）
- 惩罚：
  - 现金：$11,500 × 5% × 0.8 = $460 → 剩余 $11,040
  - 钻石：0 💎（损失<10%）

**场景B：严重未达标**
- 起始：$50,000
- 目标：$60,000
- 最终：$40,000（损失20%，实际损失$10,000）
- 惩罚：
  - 现金：$40,000 × 20% × 0.8 = $6,400 → 剩余 $33,600
  - 钻石：$10,000 ÷ 10,000 = 1 💎（损失在10-30%区间）

**场景C：极度未达标**
- 起始：$200,000
- 目标：$300,000
- 最终：$80,000（损失60%，实际损失$120,000）
- 惩罚：
  - 现金：$80,000 × 50%（封顶）= $40,000 → 剩余 $40,000
  - 钻石：$120,000 ÷ 2,000 = 60 💎（封顶300💎）

**场景D：爆仓**
- 起始：$100,000
- 最终：$0（爆仓）
- 惩罚：
  - 现金：$0
  - 钻石：约100💎（使用平方根/对数缩放，50-250💎范围）

---

## 🎨 游戏流程

1. **选择关卡** → 查看关卡简报（显示当前现金、目标金额、钻石）
2. **下注阶段** → 选择方向（多/空）和杠杆
3. **交易阶段** → 实时K线，可以：
   - 提前退出（安全撤离）
   - 使用消耗品（时间胶囊、内幕消息）
   - 等待时间结束
4. **结算阶段** → 显示结果：
   - 最终余额
   - 超额利润和钻石奖励
   - 下一关目标预览
5. **成功** → 进入局间商店（可选）→ 返回地图
6. **失败** → 选择复活/补救 → 返回地图或重新挑战

---

## ⚠️ 当前存在的问题和可优化点

### 1. 现金继承问题
- **问题**：业绩未达标时，现金"保持"但不"继承"，可能导致玩家卡在某个关卡
- **建议**：考虑是否允许部分继承（如继承80%），或者增加"放弃本关"选项

### 2. 钻石获取难度
- **问题**：Tier 4的汇率（10,000:1）可能过于苛刻
- **建议**：考虑调整汇率阶梯，或者增加其他钻石获取途径

### 3. 动态难度平衡
- **问题**：业绩倍数 > 1.5 就开始惩罚，可能对正常玩家不公平
- **建议**：提高惩罚阈值（如 > 2.0），或者使用更平滑的曲线

### 4. 装备效果不明显
- **问题**：反重力引擎和高频雷达的效果可能不够明显
- **建议**：增强装备效果，或者添加更直观的视觉反馈

### 5. 临时道具价格
- **问题**：用现金购买临时道具，但现金本身就很珍贵
- **建议**：考虑是否应该用钻石购买，或者降低价格

### 6. 关卡进度感
- **问题**：4个phase可能让玩家感觉进度缓慢
- **建议**：考虑减少phase数量（如改为2-3个），或者增加phase完成奖励

### 7. 复活成本
- **问题**：爆仓复活100💎，业绩补救50💎，成本固定可能不合理
- **建议**：根据关卡难度或差额动态调整成本

---

## 📝 数值平衡建议

### 钻石汇率优化
- 考虑将Tier 4的汇率从10,000:1调整为5,000:1
- 或者增加一个Tier 5（1,000,001+），使用20,000:1的极端汇率

### 动态难度优化
- 将惩罚阈值从1.5提高到2.0
- 使用更平滑的曲线：`增长率 = 1.2 + (业绩倍数 - 2.0)² × 0.2`

### 装备价格优化
- 考虑降低前几级的价格，让玩家更容易获得初期提升
- 或者增加装备的初始效果

---

## 🎯 核心设计理念

1. **现金 = 生命线**：必须谨慎管理，失败代价巨大
2. **钻石 = 长期投资**：需要超额完成才能获得，鼓励贪婪但惩罚过度贪婪
3. **富人税机制**：赚得越多，下一关越难，钻石汇率越差
4. **风险与回报**：高杠杆带来高收益，但也带来高风险和更高的难度惩罚

